{% extends "layout.html" %}
{% block content %}
<style>
    /* ... (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªÙˆØ±ÙŠ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ) ... */
    .view-shooting { width: 1080px !important; height: 1920px !important; display: flex !important; align-items: center !important; justify-content: center !important; border: none !important; border-radius: 0 !important; }
    .story-card-wrapper { width: 85% !important; border-radius: 45px !important; overflow: hidden !important; display: none; box-shadow: 0 35px 70px rgba(0,0,0,0.7) !important; }
    .view-shooting .story-card-wrapper { display: block !important; }
    .story-top-label { padding: 35px !important; font-size: 2rem !important; font-weight: 900 !important; text-transform: uppercase; letter-spacing: 4px; }
    .story-body { background: rgba(0,0,0,0.95) !important; padding: 90px 45px !important; min-height: 450px !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; }
    .story-msg { font-size: 2.6rem !important; line-height: 1.4; font-weight: 600; color: #fff !important; margin-bottom: 40px !important; }

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ…Ø§Øª */
    .theme-dark.view-shooting { background: #121212 !important; }
    .theme-dark .story-card-wrapper { border: 7px solid #ffffff !important; }
    .theme-dark .story-top-label { background: #ffffff !important; color: #000000 !important; }
    .theme-dark-gold.view-shooting { background: #000 !important; }
    .theme-dark-gold .story-card-wrapper { border: 7px solid #d4af37 !important; }
    .theme-dark-gold .story-top-label { background: #d4af37 !important; color: #000 !important; }
    .theme-neon.view-shooting { background: #050505 !important; }
    .theme-neon .story-card-wrapper { border: 7px solid #39ff14 !important; }
    .theme-neon .story-top-label { background: #39ff14 !important; color: #000 !important; }

    /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
    .view-shooting .dashboard-ui { display: none !important; }
    .trash-icon { color: #dc3545; border: none; background: none; transition: 0.2s; }
    .trash-icon:hover { transform: scale(1.2); }
    .theme-opt { cursor: pointer; transition: 0.3s; border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; position: relative; color: white; }
    .theme-opt:hover { transform: translateY(-5px); }
    
    /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù„ÙˆØ­Ø© */
    .points-badge { background: transparent !important; border: 2px solid var(--neon-cyan) !important; color: var(--neon-cyan) !important; font-weight: 900; }
    .quiz-option { cursor: pointer; transition: 0.2s; border: 1px solid #444; background: #222; padding: 10px; border-radius: 12px; font-size: 0.85rem; color: white; }
    .quiz-option:hover { background: var(--neon-cyan); color: black; border-color: var(--neon-cyan); }
    
    /* Ø³ØªØ§ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .hint-btn {
        background: transparent;
        border: 1px dashed var(--neon-pink);
        color: var(--neon-pink);
        font-size: 0.75rem;
        padding: 5px 15px;
        border-radius: 10px;
        transition: 0.3s;
    }
    .hint-btn:hover {
        background: var(--neon-pink);
        color: white;
        box-shadow: 0 0 10px var(--neon-pink);
    }
    .unlocked-hint {
        background: rgba(255, 45, 149, 0.1);
        border: 1px solid var(--neon-pink);
        color: var(--neon-pink);
        font-weight: 800;
        padding: 5px 15px;
        border-radius: 10px;
        text-shadow: 0 0 5px var(--neon-pink);
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-8 text-center">
        <div class="card shadow-sm p-4 mb-4 border-0 dashboard-ui">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold mb-0 text-white">Welcome, {{ current_user.username }}</h3>
                <div class="badge points-badge p-2 px-3 rounded-pill shadow-sm">
                    <i class="bi bi-trophy-fill me-1"></i> {{ current_user.points or 0 }} Points
                </div>
            </div>
            
            <div class="input-group mb-2 shadow-sm">
                <input type="text" id="myLink" class="form-control text-center bg-dark text-white border-0" value="{{ url_for('send_message', username=current_user.username, _external=True) }}" readonly>
                <button class="btn btn-primary px-4 fw-bold" onclick="copyLink()">Copy Link</button>
            </div>
            <div class="badge bg-primary p-2 px-4 rounded-pill shadow-sm">Inbox: {{ count }} Messages</div>
        </div>

        <div class="card shadow-sm border-0 mb-4 rounded-4 dashboard-ui overflow-hidden">
            <div class="card-header bg-dark text-white border-0 py-3 text-center">
                <h6 class="mb-0 fw-bold"><i class="bi bi-star-fill text-warning me-2"></i> LEADERBOARD</h6>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-pills nav-rank nav-fill bg-dark p-2" id="rankTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#friendsRank">Friends ğŸ‘¥</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#globalRank">Global ğŸŒ</button>
                    </li>
                </ul>
                <div class="tab-content p-3">
                    <div class="tab-pane fade show active" id="friendsRank">
                        {% for f_user in friends_top %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded-3 rank-item {{ 'border border-primary' if f_user.id == current_user.id else '' }}">
                            <span class="small fw-bold text-white">#{{ loop.index }} {{ f_user.username }}</span>
                            <span class="badge bg-primary rounded-pill">{{ f_user.points }} Pts</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <h5 class="text-start mb-3 fw-bold text-white dashboard-ui">Messages</h5>
        <div class="row">
            {% for msg in messages %}
            <div class="col-12 mb-3">
                <div id="msg-card-{{ msg.id }}" class="card shadow-sm text-start position-relative border-0" style="border-radius: 20px; overflow: hidden;">
                    
                    <div class="dashboard-ui p-4">
                        <p class="mb-3 fs-5 fw-medium text-white">{{ msg.content }}</p>
                        
                        {% if msg.correct_name and not msg.is_guessed %}
                        <div class="bg-dark p-3 rounded-4 mb-3 border border-secondary shadow-sm text-center">
                            <p class="small fw-bold mb-2 text-white">Who sent this? Guess & Earn +1 Pt ğŸ¯</p>
                            <div class="d-grid gap-2">
                                <button class="quiz-option fw-bold" onclick="submitGuess({{msg.id}}, '{{msg.name_opt_1}}')">{{msg.name_opt_1}}</button>
                                <button class="quiz-option fw-bold" onclick="submitGuess({{msg.id}}, '{{msg.name_opt_2}}')">{{msg.name_opt_2}}</button>
                                <button class="quiz-option fw-bold" onclick="submitGuess({{msg.id}}, '{{msg.name_opt_3}}')">{{msg.name_opt_3}}</button>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            {% if msg.hint_unlocked %}
                                <div class="unlocked-hint d-inline-block">
                                    <i class="bi bi-unlock-fill me-1"></i> Sender's 1st Letter: <strong>{{ msg.sender_name_hint if msg.sender_name_hint else '?' }}</strong>
                                </div>
                            {% else %}
                                <button class="hint-btn" onclick="unlockHint({{ msg.id }})">
                                    <i class="bi bi-key-fill me-1"></i> Unlock Name Hint (5 Pts)
                                </button>
                            {% endif %}
                        </div>

                        <div class="d-flex align-items-center justify-content-between mt-3">
                            <small class="text-muted"><i class="bi bi-clock-fill me-1"></i> {{ format_date(msg.timestamp) }}</small>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-dark rounded-pill py-1 px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#themeModal" onclick="activeMsgId = '{{ msg.id }}'">
                                    <i class="bi bi-share-fill me-1"></i> Share Story
                                </button>
                            </div>
                        </div>
                        
                        <form action="{{ url_for('delete_message', msg_id=msg.id) }}" method="POST" class="position-absolute top-0 end-0 m-2">
                            <button type="submit" class="trash-icon" onclick="return confirm('Delete?')"><i class="bi bi-trash3-fill"></i></button>
                        </form>
                    </div>

                    <div class="story-card-wrapper">
                        <div class="story-top-label text-center">ANONYMOUS MESSAGES</div>
                        <div class="story-body text-center">
                            <div class="story-msg">{{ msg.content }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
let activeMsgId = null;

// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„ØªÙ„Ù…ÙŠØ­
function unlockHint(msgId) {
    if (!confirm("Unlock the first letter of the sender's name for 5 Points?")) return;

    fetch(`/unlock_hint/${msgId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') {
            alert(`Hint Unlocked! The first letter is: ${data.hint}`);
            location.reload();
        } else {
            alert(data.message);
        }
    });
}

function submitGuess(msgId, answer) {
    fetch(`/check_answer/${msgId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({answer: answer})
    }).then(res => res.json()).then(data => {
        if(data.status === 'correct') {
            alert("Correct! ğŸ† Point earned.");
            location.reload();
        } else {
            alert("Wrong Answer!");
        }
    });
}

function copyLink() {
    var copyText = document.getElementById("myLink"); 
    copyText.select(); 
    document.execCommand("copy"); 
    alert("Link Copied! ğŸš€");
}

function downloadStory(themeClass) {
    if (!activeMsgId) return;
    const card = document.getElementById('msg-card-' + activeMsgId);
    const originalClass = card.className;
    card.classList.add(themeClass); 
    card.classList.add('view-shooting');
    html2canvas(card, { width: 1080, height: 1920, scale: 2, useCORS: true, backgroundColor: '#000' }).then(canvas => {
        canvas.toBlob(blob => {
            const file = new File([blob], "Secret_Message.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ files: [file], title: 'Secret Message', text: 'Guess who sent this!' });
            } else {
                const link = document.createElement('a'); link.download = `Secret_Message.png`; link.href = canvas.toDataURL("image/png"); link.click();
            }
            card.className = originalClass;
        }, 'image/png');
    });
}
</script>
{% endblock %}
