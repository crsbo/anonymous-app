{% extends "layout.html" %}
{% block content %}
<style>
    /* 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªÙˆØ±ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
    .view-shooting {
        width: 1080px !important;
        height: 1920px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border: none !important;
        border-radius: 0 !important;
    }

    /* ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù†Øµ */
    .story-card-wrapper {
        width: 85% !important;
        border-radius: 40px !important;
        overflow: hidden !important; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø­ÙˆØ§Ù ØªØ¨Ù‚Ù‰ Ù†Ø§Ø¹Ù…Ø© */
        display: none; 
        box-shadow: 0 30px 60px rgba(0,0,0,0.6) !important;
    }

    .view-shooting .story-card-wrapper {
        display: block !important;
    }

    /* Ø§Ù„Ù€ Header Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ (ÙˆØ§Ø®Ø¯ Ù„ÙˆÙ† Ø§Ù„Ø«ÙŠÙ…) */
    .story-top-label {
        padding: 30px !important;
        font-size: 1.8rem !important;
        font-weight: 900 !important;
        text-transform: uppercase;
        letter-spacing: 3px;
    }

    /* Ø¬Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚Ø©) */
    .story-body {
        background: rgba(0,0,0,0.85) !important;
        padding: 80px 40px !important;
        min-height: 300px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .story-msg {
        font-size: 2.5rem !important;
        line-height: 1.3;
        font-weight: 600;
        color: #fff !important; /* Ø§Ù„Ù†Øµ Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø£Ø¨ÙŠØ¶ Ø£Ùˆ ÙØ§ØªØ­ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± */
    }

    /* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ…Ø§Øª */
    /* Ø¬ÙˆÙ„Ø¯ */
    .theme-dark-gold.view-shooting { background: #000 !important; }
    .theme-dark-gold .story-card-wrapper { border: 6px solid #d4af37 !important; }
    .theme-dark-gold .story-top-label { background: #d4af37 !important; color: #000 !important; }
    .theme-dark-gold .story-msg { color: #f1e5ac !important; }

    /* Ù†ÙŠÙˆÙ† */
    .theme-neon.view-shooting { background: #050505 !important; }
    .theme-neon .story-card-wrapper { border: 6px solid #39ff14 !important; }
    .theme-neon .story-top-label { background: #39ff14 !important; color: #000 !important; }
    .theme-neon .story-msg { color: #39ff14 !important; text-shadow: 0 0 10px #39ff14; }

    /* Ø¯Ø§Ø±Ùƒ */
    .theme-dark.view-shooting { background: #1a1a1a !important; }
    .theme-dark .story-card-wrapper { border: 6px solid #fff !important; }
    .theme-dark .story-top-label { background: #fff !important; color: #000 !important; }
    .theme-dark .story-msg { color: #fff !important; }

    /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
    .view-shooting .dashboard-content, .view-shooting .delete-form, .view-shooting .premium-info, .view-shooting small {
        display: none !important;
    }

    .trash-icon { color: #dc3545; border: none; background: none; padding: 5px; }
    .theme-opt { cursor: pointer; transition: 0.2s; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .theme-opt:hover { transform: scale(1.1); }
</style>

<div class="row justify-content-center">
    <div class="col-md-8 text-center">
        <div class="card shadow-sm p-4 mb-4 border-0" style="border-radius: 20px;">
            <h3 class="fw-bold">Welcome, {{ current_user.username }}!</h3>
            <div class="input-group mb-3 mt-3">
                <input type="text" id="myLink" class="form-control text-center bg-light border-0" value="{{ url_for('send_message', username=current_user.username, _external=True) }}" readonly>
                <button class="btn btn-primary px-4 fw-bold" onclick="copyLink()">Copy</button>
            </div>
            <div class="badge bg-primary p-2 px-4 rounded-pill d-inline-block">Inbox: {{ count }} Messages</div>
        </div>

        <h5 class="text-start mb-3 fw-bold">My Messages</h5>
        <div class="row">
            {% for msg in messages %}
            <div class="col-12 mb-3">
                <div id="msg-card-{{ msg.id }}" class="card shadow-sm p-0 text-start position-relative border-0" style="border-radius: 20px; background: white; overflow: hidden;">
                    
                    <div class="dashboard-content p-4">
                        <p class="mb-3 fs-5 fw-medium text-dark">{{ msg.content }}</p>
                    </div>

                    <div class="story-card-wrapper">
                        <div class="story-top-label text-center">ANONYMOUS MESSAGES</div>
                        <div class="story-body text-center">
                            <div class="story-msg">{{ msg.content }}</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-content p-4 pt-0 d-flex align-items-center justify-content-between">
                        <small class="text-muted"><i class="bi bi-clock-fill me-1"></i> {{ format_date(msg.timestamp) }}</small>
                        <div class="premium-info d-flex align-items-center">
                            {% if current_user.is_premium %}
                                <button class="btn btn-sm btn-dark rounded-pill py-1 px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#themeModal" onclick="activeMsgId = '{{ msg.id }}'">
                                    <i class="bi bi-instagram me-1"></i> Share
                                </button>
                            {% else %}
                                <span class="text-muted small"><i class="bi bi-lock-fill"></i> Locked</span>
                            {% endif %}
                        </div>
                    </div>

                    <form action="{{ url_for('delete_message', msg_id=msg.id) }}" method="POST" class="delete-form position-absolute top-0 end-0 m-2">
                        <button type="submit" class="trash-icon"><i class="bi bi-trash3-fill"></i></button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="themeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header bg-dark text-white border-0 text-center"><h5 class="modal-title fw-bold w-100">Choose Style ğŸ¨</h5></div>
      <div class="modal-body py-5 bg-light d-flex justify-content-around">
            <div class="theme-opt" onclick="downloadStory('theme-dark-gold')" style="width: 85px; height: 85px; background: #000; border: 3px solid #d4af37; color: #d4af37;">Gold</div>
            <div class="theme-opt" onclick="downloadStory('theme-neon')" style="width: 85px; height: 85px; background: #000; border: 3px solid #39ff14; color: #39ff14;">Neon</div>
            <div class="theme-opt" onclick="downloadStory('theme-dark')" style="width: 85px; height: 85px; background: #1a1a1a; border: 3px solid #fff; color: #fff;">Dark</div>
      </div>
    </div>
  </div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
let activeMsgId = null;
function copyLink() {
    var copyText = document.getElementById("myLink"); copyText.select(); document.execCommand("copy"); alert("Link Copied! ğŸš€");
}
function downloadStory(themeClass) {
    if (!activeMsgId) return;
    const card = document.getElementById('msg-card-' + activeMsgId);
    const originalClass = card.className;
    card.classList.add(themeClass); card.classList.add('view-shooting');
    html2canvas(card, { width: 1080, height: 1920, scale: 2, backgroundColor: null, useCORS: true }).then(canvas => {
        const link = document.createElement('a'); link.download = `Anonymous_Story.png`; link.href = canvas.toDataURL("image/png"); link.click();
        card.className = originalClass;
        bootstrap.Modal.getInstance(document.getElementById('themeModal')).hide();
    });
}
</script>
{% endblock %}
